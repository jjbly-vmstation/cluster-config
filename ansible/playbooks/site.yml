---
# Site Playbook - Main Entry Point for Cluster Configuration
# 
# This playbook orchestrates all infrastructure configuration for the VMStation cluster.
# It imports all component playbooks and ensures proper execution order.
#
# Usage:
#   Full deployment:
#     ansible-playbook -i inventory/production/hosts.yml playbooks/site.yml
#   
#   Selective deployment:
#     ansible-playbook -i inventory/production/hosts.yml playbooks/site.yml --tags ntp
#     ansible-playbook -i inventory/production/hosts.yml playbooks/site.yml --tags security
#
# Required Variables:
#   - environment_name: Target environment (production/staging)
#
# Author: VMStation Team
# License: MIT

- name: VMStation Cluster Configuration - Site Playbook
  hosts: all
  become: true
  gather_facts: true

  pre_tasks:
    - name: Display deployment information
      ansible.builtin.debug:
        msg: |
          ============================================
          VMStation Cluster Configuration Deployment
          ============================================
          Target Host: {{ inventory_hostname }}
          Environment: {{ environment_name | default('unknown') }}
          Timestamp: {{ ansible_date_time.iso8601 }}
          ============================================

    - name: Verify Ansible version
      ansible.builtin.assert:
        that:
          - ansible_version.full is version('2.9', '>=')
        fail_msg: "Ansible 2.9 or higher is required"
        success_msg: "Ansible version {{ ansible_version.full }} meets requirements"

    - name: Gather required facts
      ansible.builtin.setup:
        gather_subset:
          - min
          - network
          - distribution
      when: ansible_facts.distribution is not defined

    - name: Ensure backup directory exists
      ansible.builtin.file:
        path: "{{ config_backup_dir | default('/var/backup/config') }}"
        state: directory
        mode: '0750'
        owner: root
        group: root

  roles:
    - role: common
      tags: [common, baseline]

    - role: ntp
      tags: [ntp, time, baseline]
      when: ntp_enabled | default(true)

    - role: syslog
      tags: [syslog, logging, baseline]
      when: syslog_enabled | default(true)

    - role: security-hardening
      tags: [security, hardening, baseline]
      when: security_hardening_enabled | default(true)

    - role: kerberos
      tags: [kerberos, authentication]
      when: kerberos_enabled | default(false)

  post_tasks:
    - name: Display deployment completion
      ansible.builtin.debug:
        msg: |
          ============================================
          Deployment Complete for {{ inventory_hostname }}
          ============================================
          All configured roles have been applied.
          Review logs at: {{ log_dir | default('/var/log/vmstation') }}
          ============================================

    - name: Create deployment marker
      ansible.builtin.copy:
        content: |
          deployment_timestamp: "{{ ansible_date_time.iso8601 }}"
          ansible_version: "{{ ansible_version.full }}"
          environment: "{{ environment_name | default('unknown') }}"
          host: "{{ inventory_hostname }}"
        dest: /etc/vmstation-deployment-info.yml
        mode: '0644'
      tags: [always]
