---
# Baseline Security Hardening Playbook
#
# Implements security hardening based on CIS Benchmarks and STIG guidelines.
# Configures SSH, firewall, user management, and system security parameters.
#
# Usage:
#   Full hardening:
#     ansible-playbook -i inventory/production/hosts.yml playbooks/baseline-hardening.yml
#   
#   Selective hardening:
#     ansible-playbook -i inventory/production/hosts.yml playbooks/baseline-hardening.yml --tags ssh
#     ansible-playbook -i inventory/production/hosts.yml playbooks/baseline-hardening.yml --tags firewall
#
# Warning:
#   Review settings before applying to production. Some hardening may break
#   applications that depend on legacy configurations.
#
# Author: VMStation Team
# License: MIT

- name: Apply Baseline Security Hardening
  hosts: all
  become: true
  gather_facts: true

  vars:
    # SSH Hardening defaults
    ssh_port: "{{ security_ssh_port | default(22) }}"
    ssh_permit_root_login: "{{ 'no' if security_disable_root_login | default(false) else 'prohibit-password' }}"
    ssh_password_auth: "{{ 'no' if not (security_password_auth | default(false)) else 'yes' }}"
    ssh_permit_empty_passwords: "{{ 'yes' if security_permit_empty_passwords | default(false) else 'no' }}"
    
    # Firewall defaults
    allowed_ssh_networks:
      - 192.168.4.0/24
      - 127.0.0.1/8

    # Password policy
    password_min_length: 12
    password_max_age: 90
    password_min_age: 7

  pre_tasks:
    - name: Display hardening configuration
      ansible.builtin.debug:
        msg: |
          Applying Security Hardening to {{ inventory_hostname }}
          SSH Port: {{ ssh_port }}
          Root Login: {{ ssh_permit_root_login }}
          Password Auth: {{ ssh_password_auth }}

    - name: Create security backup
      ansible.builtin.shell: |
        set -o pipefail
        backup_dir="/var/backup/security-$(date +%Y%m%d-%H%M%S)"
        mkdir -p "$backup_dir"
        cp -p /etc/ssh/sshd_config "$backup_dir/" 2>/dev/null || true
        cp -p /etc/login.defs "$backup_dir/" 2>/dev/null || true
        cp -p /etc/sysctl.conf "$backup_dir/" 2>/dev/null || true
        echo "$backup_dir"
      args:
        executable: /bin/bash
      register: backup_result
      changed_when: false
      tags: [backup]

  tasks:
    # SSH Hardening
    - name: Configure SSH hardening
      tags: [ssh, security]
      block:
        - name: Ensure SSH configuration directory exists
          ansible.builtin.file:
            path: /etc/ssh/sshd_config.d
            state: directory
            mode: '0755'

        - name: Deploy SSH hardening configuration
          ansible.builtin.copy:
            content: |
              # {{ ansible_managed | default('Managed by Ansible') }}
              # SSH Security Hardening Configuration

              # Disable protocol version 1
              Protocol 2

              # Strong algorithms only
              KexAlgorithms curve25519-sha256,curve25519-sha256@libssh.org,diffie-hellman-group-exchange-sha256
              Ciphers chacha20-poly1305@openssh.com,aes256-gcm@openssh.com,aes128-gcm@openssh.com,aes256-ctr,aes192-ctr,aes128-ctr
              MACs hmac-sha2-512-etm@openssh.com,hmac-sha2-256-etm@openssh.com,hmac-sha2-512,hmac-sha2-256

              # Authentication settings
              PermitRootLogin {{ ssh_permit_root_login }}
              PasswordAuthentication {{ ssh_password_auth }}
              PermitEmptyPasswords {{ ssh_permit_empty_passwords }}
              MaxAuthTries 3
              MaxSessions 10

              # Disable unused features
              X11Forwarding no
              AllowAgentForwarding no
              AllowTcpForwarding no
              PermitTunnel no

              # Logging
              SyslogFacility AUTH
              LogLevel VERBOSE

              # Timeouts
              ClientAliveInterval 300
              ClientAliveCountMax 2
              LoginGraceTime 60

              # Banner
              Banner /etc/issue.net
            dest: /etc/ssh/sshd_config.d/99-hardening.conf
            owner: root
            group: root
            mode: '0600'
            validate: '/usr/sbin/sshd -t -f %s || true'
          notify: Restart SSH

        - name: Create login banner
          ansible.builtin.copy:
            content: |
              ******************************************************************
              *                                                                *
              *  AUTHORIZED ACCESS ONLY                                        *
              *                                                                *
              *  This system is the property of {{ organization_name | default('VMStation') }}.              *
              *  Unauthorized access is prohibited and will be prosecuted.     *
              *  All connections are logged and monitored.                     *
              *                                                                *
              ******************************************************************
            dest: /etc/issue.net
            owner: root
            group: root
            mode: '0644'

    # Kernel Security Parameters
    - name: Configure kernel security parameters
      tags: [sysctl, security]
      block:
        - name: Deploy security sysctl configuration
          ansible.builtin.copy:
            content: |
              # {{ ansible_managed | default('Managed by Ansible') }}
              # Security Kernel Parameters

              # Network security
              net.ipv4.tcp_syncookies = 1
              net.ipv4.conf.all.accept_redirects = 0
              net.ipv4.conf.default.accept_redirects = 0
              net.ipv4.conf.all.secure_redirects = 0
              net.ipv4.conf.default.secure_redirects = 0
              net.ipv4.conf.all.send_redirects = 0
              net.ipv4.conf.default.send_redirects = 0
              net.ipv4.conf.all.accept_source_route = 0
              net.ipv4.conf.default.accept_source_route = 0
              net.ipv4.conf.all.log_martians = 1
              net.ipv4.conf.default.log_martians = 1
              net.ipv4.icmp_echo_ignore_broadcasts = 1
              net.ipv4.icmp_ignore_bogus_error_responses = 1

              # IPv6 settings
              net.ipv6.conf.all.accept_redirects = 0
              net.ipv6.conf.default.accept_redirects = 0
              net.ipv6.conf.all.accept_source_route = 0
              net.ipv6.conf.default.accept_source_route = 0

              # Core dump restrictions
              fs.suid_dumpable = 0

              # Randomize virtual memory regions
              kernel.randomize_va_space = 2

              # Restrict kernel pointer exposure
              kernel.kptr_restrict = 2

              # Restrict dmesg access
              kernel.dmesg_restrict = 1
            dest: /etc/sysctl.d/99-security.conf
            owner: root
            group: root
            mode: '0644'
          notify: Reload sysctl

    # Password Policy
    - name: Configure password policy
      tags: [password, security]
      block:
        - name: Set password aging policy
          ansible.builtin.lineinfile:
            path: /etc/login.defs
            regexp: "^{{ item.key }}"
            line: "{{ item.key }} {{ item.value }}"
          loop:
            - { key: 'PASS_MAX_DAYS', value: "{{ password_max_age }}" }
            - { key: 'PASS_MIN_DAYS', value: "{{ password_min_age }}" }
            - { key: 'PASS_MIN_LEN', value: "{{ password_min_length }}" }
            - { key: 'PASS_WARN_AGE', value: '14' }

    # File Permissions
    - name: Secure critical file permissions
      tags: [permissions, security]
      block:
        - name: Set secure permissions on critical files
          ansible.builtin.file:
            path: "{{ item.path }}"
            mode: "{{ item.mode }}"
            owner: root
            group: root
          loop:
            - { path: /etc/passwd, mode: '0644' }
            - { path: /etc/shadow, mode: '0600' }
            - { path: /etc/group, mode: '0644' }
            - { path: /etc/gshadow, mode: '0600' }
            - { path: /etc/ssh/sshd_config, mode: '0600' }
          ignore_errors: true

    # Audit Logging
    - name: Configure audit logging
      tags: [audit, security]
      block:
        - name: Install auditd (Debian)
          ansible.builtin.apt:
            name: auditd
            state: present
          when: ansible_os_family == 'Debian'

        - name: Install auditd (RedHat)
          ansible.builtin.dnf:
            name: audit
            state: present
          when: ansible_os_family == 'RedHat'

        - name: Enable auditd service
          ansible.builtin.service:
            name: auditd
            enabled: true
            state: started

  handlers:
    - name: Restart SSH
      ansible.builtin.service:
        name: "{{ 'ssh' if ansible_os_family == 'Debian' else 'sshd' }}"
        state: restarted

    - name: Reload sysctl
      ansible.builtin.command:
        cmd: sysctl --system
      changed_when: true

  post_tasks:
    - name: Verify SSH configuration
      ansible.builtin.command:
        cmd: sshd -t
      register: ssh_test
      changed_when: false
      failed_when: false
      tags: [verify]

    - name: Display hardening summary
      ansible.builtin.debug:
        msg: |
          ========================================
          Security Hardening Complete for {{ inventory_hostname }}
          ========================================
          SSH Config Test: {{ 'PASSED' if ssh_test.rc == 0 else 'FAILED' }}
          Backup Location: {{ backup_result.stdout }}
          
          Applied Controls:
          - SSH hardening with modern algorithms
          - Kernel security parameters
          - Password policy enforcement
          - File permissions secured
          - Audit logging enabled
          ========================================
