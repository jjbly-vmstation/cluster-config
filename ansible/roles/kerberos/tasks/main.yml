---
# Kerberos Role - Main Tasks
#
# Configures Kerberos client or FreeIPA integration

- name: Install Kerberos client packages (Debian)
  ansible.builtin.apt:
    name: "{{ kerberos_packages_debian }}"
    state: present
    update_cache: true
  when: ansible_os_family == 'Debian'
  tags: [install]

- name: Install Kerberos client packages (RedHat)
  ansible.builtin.dnf:
    name: "{{ kerberos_packages_redhat }}"
    state: present
  when: ansible_os_family == 'RedHat'
  tags: [install]

- name: Deploy Kerberos configuration
  ansible.builtin.template:
    src: krb5.conf.j2
    dest: /etc/krb5.conf
    owner: root
    group: root
    mode: '0644'
    backup: true
  tags: [configure]

- name: Configure SSSD for Kerberos
  when: kerberos_sssd_enabled | default(true)
  tags: [sssd]
  block:
    - name: Create SSSD configuration
      ansible.builtin.template:
        src: sssd.conf.j2
        dest: /etc/sssd/sssd.conf
        owner: root
        group: root
        mode: '0600'
      notify: Restart SSSD

    - name: Enable SSSD service
      ansible.builtin.service:
        name: sssd
        enabled: true
        state: started

- name: Configure PAM for Kerberos
  when: kerberos_pam_enabled | default(false)
  tags: [pam]
  block:
    - name: Enable pam_krb5 (Debian)
      ansible.builtin.command:
        cmd: pam-auth-update --enable krb5
      when: ansible_os_family == 'Debian'
      changed_when: false

- name: Display Kerberos configuration status
  ansible.builtin.debug:
    msg: |
      Kerberos configured for {{ inventory_hostname }}
      Realm: {{ kerberos_realm }}
      KDC: {{ kerberos_kdc_servers | join(', ') }}
  tags: [verify]
